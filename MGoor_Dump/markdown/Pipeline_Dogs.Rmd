---
title: "Pipeline Paleodogs"
author: "By Paleodogs Team"
date: "12/04/2022"
output:
  html_document:
    css: bioconductor.css
    code_folding: hide
    number_sections: yes
    theme: united
    highlight: tango
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
      smooth_scroll: no
  pdf_document:
    toc: yes
    toc_depth: '6'
---
<img src= C:/Users/Gaia/Desktop/Mahaut/UNIV/COURS/M1/S7/SYS/SIBUT/bandeau_unite.jpg
alt="Drawing" style="width:600px:"/>

<a id="top"></a>

Cette pipeline est utilisée pour l'analyse des données du projet CROC issues de 2021 

```{r, echo=F, eval=T, warning=F}
library(DiagrammeR)
mermaid("
graph TD
    A(Capture) --> B(Séquençage)
    B --> C(ETAPE 1 - Elimination des adaptateurs en SE - CUTADAPT)
    C --> D(ETAPE 2 - Elimination des adaptateurs en SE - FASTP)
    D --> E(ETAPE 2 BIS - METAGE - Biocuration du reste des adaptateurs - GENEIOUS)
    E --> F(ETAPE 3 - Pairing des reads - BBTOOLS)
    D --> F
    F --> G(ETAPE 4 - Merging des reads pairés et filtration des reads - FASTP)
    G --> H(ETAPE 5 - Filtration de longueur - FASTP)
    H --> I(ETAPE 6 - Suppression des duplicats de PCR - FASTP)

")
```

# ETAPE 1 - Elimination des adaptateurs sur R1 et R2 

## Outil - CUTADAPT
_Cutadapt trouve et supprime les séquences d’adaptateurs, les amorces, les queues poly-A et et poly-G._

### Script
```{bash, echo=T, eval=F}
source /local/env/envcutadapt-1.15.sh

cutadapt $Dir0${number}_R1.fq -a AGATCGGAAGAGCACACGTCTGAACTCCAGTCA -O 3 -e 0.5 -o $Dir1${number}_R1_cutadapt.fq > $Dir1${number}_R1_cutadapt_report.txt
cutadapt $Dir0${number}_R2.fq -a AGATCGGAAGAGCACACGTCTGAACTCCAGTCA -O 3 -e 0.5 -o $Dir1${number}_R2_cutadapt.fq > $Dir1${number}_R2_cutadapt_report.txt

# Pour les METAGE, on enlève les untrimmed avec l'option:
#--untrimmed-output=$path_untrimmed/1804_cutadapt_R1_untrim.fastq.gz
```


### Options choisies

* -o = Nom du fichier d'output
* -i = Nom du fichier d'input
* -e = Seuil d'erreur autorisé pour la reconnaissance des adaptateurs: ici 0.5 __(A changer ?)__
* -O = Overlap de minimum 3 autorisé 
* --untrimmed-output = nom du fichier d'output pour les reads untrimmed
* -a = séquence de l'adaptateur: 
  * R1: AGATCGGAAGAGCACACGTCTGAACTCCAGTCA
  * R2: AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT

# ETAPE 2 - Filtration des reads 

## Outil - FASTP

_Cet outil Prend la suite de CUTADAPT et coupe ce qu'il reste d'adaptateurs à couper. Il permet ensuite de filtrer les reads._

Page de documentation de FASTP: 
<u>https://github.com/OpenGene/fastp/blob/master/README.md</u>

### Script
```{bash, echo=T, eval=F}
source /local/env/envfastp-0.20.0.sh

fastp -i $Dir1${number}_R1_cutadapt.fq --adapter_sequence=AGATCGGAAGAGCACACGTCTGAACTCCAGTCA --average_qual 20 -l 25 --trim_poly_g --trim_poly_x -o $Dir2${number}_R1_rmadapt.fq --cut_right --cut_right_mean_quality 25 -h $Dir2${number}_R1_rmadapt.html > $Dir2${number}_R1_rmadapt_report.txt
fastp -i $Dir1${number}_R2_cutadapt.fq --adapter_sequence=AGATCGGAAGAGCACACGTCTGAACTCCAGTCA --average_qual 20 -l 25 --trim_poly_g --trim_poly_x -o $Dir2${number}_R2_rmadapt.fq --cut_right --cut_right_mean_quality 25 -h $Dir2${number}_R2_rmadapt.html > $Dir2${number}_R2_rmadapt_report.txt

# Pour les METAGE
# --adapter_fasta $path_adapters/adapters.fasta

#Pour les DOGS 
# --low_complexity_filter poru filtrer les régions de faible complexité.
```

### Options choisies

* -o = Nom du fichier d'output
* -i = Nom du fichier d'input
* --adapter_sequence = Séquence de l'adapteur.
* --adapter_fasta = Nom du fichier qui contient les séquences de tout les adptateurs plus ou moins tronqués.
* --average_qual = Indice de qualité minimal
* -l = longueur minimal des séquences
  * __DOGS__ = 25 nc
  * __METAGE__ = 10 nc
* --trim_poly_g = Pour enlever les PolyG
* --trim_poly_x = Pour enlever les PolyA
* --cut_right = Arrête l'analyse et coupe à droite si la qualité dans la fenêtre est inf à _cut_right_mean_quality_ 
* --cut_right_mean_quality 25 = Pour spécifier le seuil de qualité qu'on veut dans la fenêtre d'analyse
* --n_base_limit 6 = Spécifie le seuil de bases N au dessus duquel le read est rejeté.

## Etape 2bis - METAGE - Biocuration
_On retire les adaptateurs qui restent à la main sur geneious._
_Sur les untrimmed, on isole et on réinjècte les séquences qui ont quand même des adaptateurs dans les trimmed et on enlève celles qui n'en ont pas._

### Outil - GENEIOUS
.....................

# ETAPE 3 - Suppression des duplicats de PCR

_On utilise directement l'option --ddup de l'outil FASTP afin de supprimer les duplicats de PCR._

## Outil - FASTP

_Pour enlever les duplicats de PCR._

### Script

```{bash, echo=T, eval=F}
fastp -i $Dir2${number}_R1_rmadapt.fq --dedup --dup_calc_accuracy 5 -o $Dir3${number}_R1_rmduplicate.fq --disable_adapter_trimming > $Dir3${number}_R1_rmduplicate_report.txt
fastp -i $Dir2${number}_R2_rmadapt.fq --dedup --dup_calc_accuracy 5 -o $Dir3${number}_R2_rmduplicate.fq --disable_adapter_trimming > $Dir3${number}_R2_rmduplicate_report.txt
	
```

### Options choisies

* --dedup --> Discard les reads dupliqués 100% identiques et 100% de même longueur
* --dup_calc_accuracy 5 --> permet d'être plus exact sur la déduplication mais utilise un peu plus de RAM (8G au lieu de 4G), à enlever si cela prend trop de temps.

# ETAPE 4 - Merging des R1 et R2

## OutilL - FASTP

_On merge les R1 avec les R2 dans le fichier <b>merged.fq</b>._
_Les reads R1 qui ont un R2 mais dont ce dernier ne passe pas les filtres sont mis dans <b>unpaired1.fq</b>, et <b>unpaired2.fq</b> pour les R2 dont les R1 ne passent pas les filtres de QC._
_Les reads R1 qui n'ont pas de R2 sont mis dans le fichier <b>out1.fq</b>, <b>out2.fq</b> pour les réciproques.</i>_


### Script
```{bash, echo=T, eval=F}
fastp --in1 $Dir2${number}_R1_rmduplicate.fq --in2 $Dir2${number}_R2_rmduplicate.fq -m --merged_out $Dir3${number}_merged.fq --out1 $Dir3${number}_R1_unmerged.fq --out2 $Dir3${number}_R2_unmerged.fq --unpaired1 $Dir3${number}_R1_singleton.fq --unpaired2 $Dir3${number}_R2_singleton.fq --failed_out $Dir3${number}_merged_failed.fq --disable_adapter_trimming 
cat $Dir3${number}_merged.fq $Dir3${number}_R1_unmerged.fq $Dir3${number}_R2_unmerged.fq $Dir3${number}_R1_singleton.fq $Dir3${number}_R2_singleton.fq > $Dir3${number}_merging_all.fq

```

### Options choisies

* -m = option de merging
* --merged_out = Fichier de merging avec les R1 et R2 pairés et mergés
* --out1 et --out2 = Fichiers de reads unmerged 
* --unpaired1 et --unpaired2 = Fichiers de singletons R1 et R2
* --includ_unmerged = Donne un fichier avec les merged, unmerged et les singletons en même temps dans merged_out (donc pas séparé). 
* --failed_out -->  specify the file to store reads that cannot pass the filters. (string [=])
* - l 10 --> sinon coupe à 15 par défaut

# ETAPE 5 - Alignement sur le génome de référence

_On utilise le génome du chien CANFAM3 car les autres échantillons utilisés dans l'étude ont déjà été annoté avec cette version du génome._

## Outil - BWA

### Script
```{bash, echo=T, eval=F}
GENOME=PATH/TO/GENOME.fa

```

### Options choisies
