---
title: "Pipeline Paleodogs"
author: "By Paleodogs Team at ECOBIO"
date: "12/04/2022"
output:
  html_document:
    css: bioconductor.css
    code_folding: hide
    number_sections: yes
    theme: united
    highlight: tango
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
      smooth_scroll: yes
  pdf_document:
    toc: yes
    toc_depth: '6'
---
<img src= C:/Users/Gaia/Desktop/Mahaut/UNIV/COURS/M1/S7/SYS/SIBUT/bandeau_unite.jpg
alt="Drawing" style="width:600px:"/>

<a id="top"></a>

Cette pipeline est utilisée pour l'analyse des données du projet CROC issues de 2021 

```{r, echo=F, eval=T, warning=F}
library(DiagrammeR)
mermaid("
graph TD
    A(Capture) --> B(Séquençage)
    B --> C(ETAPE 1 - Elimination des adaptateurs en SE - CUTADAPT)
    C --> D(ETAPE 2 - Elimination des adaptateurs en SE - FASTP)
    D --> E(ETAPE 2 BIS - METAGE - Biocuration du reste des adaptateurs - GENEIOUS)
    E --> F(ETAPE 3 - Pairing-Merging des reads - BBTOOLS / FASTP)
    D --> F
    F --> G(ETAPE 4 - Filtration de qualité et longueur - FASTP)
    G --> H(ETAPE 5 - Suppression des duplicats de PCR - FASTP)
    H --> I(ETAPE 6 - Alignement sur le génome de référence - BWA)
    I --> J(ETAPE 7 - Extraction des reads mitochondriaux - SAMTOOLS)
    J --> K(ETAPE 7 bis - Quantification des dommages de l'ADN - MAPDAMAGE)
    J --> L(ETAPE 8 - Génération des séquences consensus - HTSBOX)
    L --> M(ETAPE 9 - Génération des halplogroupes - MITOTOOLPY)
    M --> N(ETAPE 10 - Multialignement - MAFFT)
    N --> O(ETAPE 10 bis - Cleaning de l'alignement - TRIMAI)
    O --> P(ETAPE 11 - Génération des arbres - IQTREE)

")
```

# ETAPE 1 - Elimination des adaptateurs en SE avec cutadapt

## Outil - CUTADAPT
_Cutadapt trouve et supprime les séquences d’adaptateurs, les amorces, les queues poly-A et et poly-G._

Page de documentation de CUTADAPT: 
https://cutadapt.readthedocs.io/en/stable/guide.html

### Script
```{bash, echo=T, eval=F}
source /local/env/envcutadapt-1.15.sh

cutadapt -a AGATCGGAAGAGCACACGTCTGAACTCCAGTCA -O 3 -e 0.5 -m 1 -o {SAMPLE}_R1_cutadapt.fq --untrimmed-output={SAMPLE}_R1_untrim.fq -i {SAMPLE}_R1.fq
cutadapt -a AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT -O 3 -e 0.5 -m 1 -o {SAMPLE}_R2_cutadapt.fq --untrimmed-output={SAMPLE}_R2_untrim.fq -i {SAMPLE}_R2.fq

```


### Options choisies

* -o = Nom du fichier d'output
* -i = Nom du fichier d'input
* --untrimmed-output = nom du fichier d'output pour les reads untrimmed
* -e = Seuil d'erreur autorisé pour la reconnaissance des adaptateurs: ici 50%
* -O = Overlap de minimum 3 autorisé 
* -a = séquence de l'adaptateur: 
  * R1: AGATCGGAAGAGCACACGTCTGAACTCCAGTCA
  * R2: AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT
* -m 1 = On trie les séquences qui ont moins de 1 nucléotide de longueur après trimming


# ETAPE 2 - Elimination des adaptateurs en SE avec fastp

## Outil - FASTP

_Cet outil prend la suite de CUTADAPT et coupe ce qu'il reste d'adaptateurs à couper._

Page de documentation de FASTP: 
<u>https://github.com/OpenGene/fastp/blob/master/README.md</u>

### Script
```{bash, echo=T, eval=F}
source /local/env/envfastp-0.20.0.sh

fastp -i {SAMPLE}_R1_cutadapt.fq --adapter_fasta "/groups/Paleogenomics/DOG/Adapters_&_SNIP/"adapters.fasta -o {SAMPLE}_R1_rmadapt.fq --disable_quality_filtering --disable_length_filtering --dont_eval_duplication -h {SAMPLE}_R1_rmadapt.html >{SAMPLE}_R1_rmadapt_report.txt 2>&1
fastp -i {SAMPLE}_R2_cutadapt.fq --adapter_fasta "/groups/Paleogenomics/DOG/Adapters_&_SNIP/"adapters.fasta -o {SAMPLE}_R2_rmadapt.fq --disable_quality_filtering --disable_length_filtering --dont_eval_duplication -h {SAMPLE}_R2_rmadapt.html >{SAMPLE}_R2_rmadapt_report.txt 2>&1

```

### Options choisies

* -o = Nom du fichier d'output
* -i = Nom du fichier d'input
* --adapter_sequence = Séquence de l'adapteur.
* --adapter_fasta = Nom du fichier qui contient les séquences de tout les adptateurs plus ou moins tronqués.
* --disable_quality_filtering = Pour ne pas filtrer avant l'étape de filtration
* --disable_length_filtering  = Pour ne pas enlever les reads trop courts avant le merging
* --dont_eval_duplication = Pour ne pas enlever les duplicats avant la déduplication

## Etape 2bis - METAGE - Biocuration
_On retire les adaptateurs qui restent à la main sur geneious._
_Sur les untrimmed, on isole et on réinjècte les séquences qui ont quand même des adaptateurs dans les trimmed et on enlève celles qui n'en ont pas._

### Outil - GENEIOUS
....................


# ETAPE 3 - Pairing-Merging des reads + Filtration - BBTOOLS / FASTP
Ici, on paire les reads R1 et R2 ensemble grâce au script __repair.sh__ de BBTOOLS. Puis on merge les reads avec FASTP.

## Outil - BBTOOLS

Page de documentation de BBTOOLS:
<u> https://github.com/kbaseapps/BBTools </u>

### Script

```{bash, echo=T, eval=F}
source /local/env/envconda.sh
conda activate /home/genouest/cnrs_umr6553/ddiquelou/bbtools
    
repair.sh in1={SAMPLE}_R1_rmadapt.fq in2={SAMPLE}_R2_rmadapt.fq out={SAMPLE}_R1_repair.fq out2={SAMPLE}_R2_repair.fq outs={SAMPLE}_repair_singleton.fq > {SAMPLE}_repair_report.txt
```

### Options choisies

* in1 : le fichier d'entrée des R1
* in2 : le fichier d'entrée des R2
* out : le fihcier de sorties des R1 pairés 
* out2 : le fihcier de sortie des R2 pairés
* outs le fichier de sortie des singletons

## OutilL - FASTP

_On merge les R1 avec les R2 dans le fichier <b>merged.fq</b>._
_Les reads R1 qui ont un R2 mais dont ce dernier ne passe pas les filtres sont mis dans <b>unpaired1.fq</b>, et <b>unpaired2.fq</b> pour les R2 dont les R1 ne passent pas les filtres de QC._
_Les reads R1 qui n'ont pas de R2 sont mis dans le fichier <b>out1.fq</b>, <b>out2.fq</b> pour les réciproques.</i>_
_On assemble les 6 fichiers dans un seul à l'aide de la commande cat._

### Script
```{bash, echo=T, eval=F}
source /local/env/envconda.sh
conda activate /groups/Paleogenomics/DOG/ENV/Fastp_0_23/
    
  fastp --in1 {SAMPLE}_R1_repair.fq --in2 {SAMPLE}_R2_repair.fq -A --disable_adapter_trimming --disable_length_filtering --disable_quality_filtering --dont_eval_duplication --overlap_len_require 25 -m --merged_out {SAMPLE}_merged.fq --out1 {SAMPLE}_R1_unmerged.fq --out2 {SAMPLE}_R2_unmerged.fq --unpaired1 {SAMPLE}_R1_singleton.fq --unpaired2 {SAMPLE}_R2_singleton.fq --failed_out {SAMPLE}_merged_failed.fq>{SAMPLE}_merging_report.txt 2>&1

	cat {SAMPLE}_merged.fq {SAMPLE}_R1_unmerged.fq {SAMPLE}_R2_unmerged.fq {SAMPLE}_R1_singleton.fq {SAMPLE}_R2_singleton.fq {SAMPLE}_repair_singleton.fq > {SAMPLE}_merging_all.fq

    
```

### Options choisies

Merging: 

* -m = option de merging
* --merged_out = Fichier de merging avec les R1 et R2 pairés et mergés
* --out1 et --out2 = Fichiers de reads unmerged 
* --unpaired1 et --unpaired2 = Fichiers de singletons R1 et R2
* --includ_unmerged = Donne un fichier avec les merged, unmerged et les singletons en même temps dans merged_out (donc pas séparé). 
* --failed_out = pour préciser le fichier dans lequel FastP stocke les reads qui n'ont pas passé les filtres  
* -A --disable_adapter_trimming = Pour ne pas enlever des séquences qui pourraient ressembler à des adaptateurs après le merging
* --overlap_len_require 25 : il faut un chevauchement de 25 minimum pour que les R1 et R2 soient mergés

# ETAPE 6 - Filtration de qualité et de longueur - FASTP

_On filtre les reads du fichiers merged_all en fonction de leur taille et de leur qualité, tout ceux qui sont inférieur à 25 nc pour les chiens et 10 pour les métagé sont jetés._

Les autres filtres appliqués sont les suivants: 

- PolyX
- PolyA
- Qualité moyenne de 20
- DOGS - filtre de faible complexité
- Cut_right

## Outil - FASTP

### Script
```{bash, echo=T, eval=F}
fastp -i {SAMPLE}_merging_all.fq -o {SAMPLE}_filt.fq -A --disable_adapter_trimming --dont_eval_duplication -l 25 --average_qual 20 --trim_poly_g --trim_poly_x --low_complexity_filter --cut_right --cut_right_mean_quality 20 >{SAMPLE}_filt_report.txt 2>&1

```

### Options choisies

* -l = 25 pour les DOGS
* -l = 10 pour les METAGE
* --average_qual = Indice de qualité minimal
* --trim_poly_g = Pour enlever les PolyG
* --trim_poly_x = Pour enlever les PolyA
* --cut_right = Arrête l'analyse et coupe à droite si la qualité dans la fenêtre est inf à _cut_right_mean_quality_ 
* --cut_right_mean_quality 20 = Pour spécifier le seuil de qualité qu'on veut dans la fenêtre d'analyse
* --n_base_limit 6 = Spécifie le seuil de bases N au dessus duquel le read est rejeté.



# ETAPE 6 - Sppression des duplicats de PCR - FASTP

## OUTIL - FASTP

### Script
```{bash, eval=F, echo=T}
fastp -i {SAMPLE}_filt.fq --dedup -o {SAMPLE}_rmduplicates.fq -A --disable_adapter_trimming --disable_quality_filtering --disable_length_filtering -h {SAMPLE}_rmduplicate.html>{SAMPLE}_rmduplicates_report.txt 2>&1

```

## Options choisies:

* --dedup = pour activer la suppression des duplicats de PCR


# ETAPE 6 - Alignement sur le génome de référence 
_On aligne nos reads sur le génome du chien de référence CanFam3._

## OUTIL - BWA

Page de documentation de BBTOOLS:
<u> http://bio-bwa.sourceforge.net/bwa.shtml </u>

### Script
```{bash, echo=T, eval=F}
sed -n '1~4s/^@/>/p;2~4p' {SAMPLE}_rmduplicates.fq > {SAMPLE}_rmduplicates.fasta

GENOME=/groups/dog/data/canFam3/sequence/bwa_index/Canis_familiaris.CanFam3.1.72.dna_sm.toplevel.fa

source /local/env/envbwa-0.7.17.sh

bwa aln -t 8 -l 1024 -o 2 -n 0.01 $GENOME {SAMPLE}_rmduplicates.fasta > {SAMPLE}_aln.sai
bwa samse $GENOME {SAMPLE}_aln.sai {SAMPLE}_rmduplicates.fq > {SAMPLE}_aln_samse.sam

```

La première commande sert à convertir le fichier .fq en fasta (on enlève les lignes de qualité).
La deuxième permet de spécifier le chemin du génome de référence.


### Options choisies

* -n = distance de Levenshtein, mesure de la similarité entre deux séquences, ici le maximum de distance est à 1%.
* -t = nombre de coeurs utilisés
* -l = longueur de la graine, ici on met 1024 pour être sûrs de ne pas avoir de reads plus longs de celle-ci.
* -o = nombre maximal d'ouverture de gaps 

# ETAPE 7 - Extraction des reads mitochondriaux 
_Ici on filtre les reads qui ont mappé sur le génome du chien (DOGS) ou qui n'ont pas mappé (METAGE)._ 
_On filtre également les reads dont la qualité de mapping est inférieur à 25._ 
_On convertie bam, on index et tri les bam, puis on filtre les reads qui ont mappé sur le génome mitochondrial._ 


## OUTIL - SAMTOOLS

Page de documentation de SAMTOOLS:
<u> http://www.htslib.org/doc/samtools-view.html </u>

### Script
```{bash, echo=T, eval=F}
source /local/env/envsamtools-1.15.sh

    # on filtre les unmapped
	samtools view -bT {SAMPLE}_rmduplicates.fasta -F 4 {SAMPLE}_aln_samse.sam > {SAMPLE}_aln_samse_mapped.sam 
    
    # on filtre les reads d'une qualité < 25
    samtools view -h -q 25 {SAMPLE}_aln_samse_mapped.sam > {SAMPLE}_aln_samse_mappedQ25.sam 
    
    # sam to bam mapped Q25
    samtools view -S -b {SAMPLE}_aln_samse_mappedQ25.sam > {SAMPLE}_aln_samse_mappedQ25.bam 
    
    #sort par read_name
    samtools sort -n --threads 6 {SAMPLE}_aln_samse_mappedQ25.bam -o {SAMPLE}_sort.bam

    #fixmate
    samtools fixmate -m --threads 6 {SAMPLE}_sort.bam {SAMPLE}_sort_fixmate.bam

    #sort per coordinates
    samtools sort --threads 6 -o {SAMPLE}_sort_fixmate.sorted.bam {SAMPLE}_sort_fixmate.bam

    ##flagstat du markdup
    samtools flagstat {SAMPLE}_sort_fixmate.sorted.bam > {SAMPLE}_sort_fixmate_flagstat.sorted.bam ### attention à l'extention là

    ##index le fichier markdup.bam
    samtools index -@ 8 {SAMPLE}_sort_fixmate.sorted.bam > {SAMPLE}_sort_fixmate.sorted.bam.bai

    ##extraire les MT
    samtools view {SAMPLE}_sort_fixmate.sorted.bam MT -o {SAMPLE}_sort_fixmate_MT.sorted.bam
    samtools view {SAMPLE}_sort_fixmate_MT.sorted.bam > {SAMPLE}_sort_fixmate_MT_view.sorted.bam
    
    samtools flagstat {SAMPLE}_sort_fixmate_MT.sorted.bam > {SAMPLE}_sort_fixmate_MT_flagstat.sorted.txt

    samtools coverage {SAMPLE}_sort_fixmate_MT.sorted.bam > {SAMPLE}_samcoverage.txt
    samtools depth {SAMPLE}_sort_fixmate_MT.sorted.bam > {SAMPLE}_samdepth.txt

```


### Options choisies

* -b = pour préciser que la sortie est au format bam
* -S = pour préciser que l'entrée est au format sam
* -T = pour lui spécifier un fichier fasta de référence
* -F = pour récupérer les reads mappés
* -h = pour inclure le header dans l'output
* -q 25 = filtre de qualité 25
* -n = trier par les noms 
* -- threads = pour préciser le nombre de coeurs
* fixmate permet de retrouver les coordonnées des paires sur un alignement trié par les noms
* flagstat permet de récupérer les stats de l'alignemnt, à savoir le nombre de mapped et unmapped
* coverage = permet de récupérer la couverture sur le génome mitochondrial
* depth = permet de récupérer la profondeur moyenne 


# ETAPE 7 bis - Quantification des motifs de dommages de l'ADN 
_On utilise cet outil pour prouver que l'ADN étudié est bien de l'ADN ancien grâce à la reconnaissance des motifs de dommages._

## OUTIL - MAPDAMAGE
Page de documentation de MAPDAMAGE:
<u>https://github.com/ginolhac/mapDamage</u>


### Script
```{bash, echo=T, eval=F}
    source /local/env/envconda.sh
    conda activate /groups/Paleogenomics/ENV/MapDamage-2.2.1

    mapDamage -i {SAMPLE}_sort_fixmate_MT.sorted.bam -r $GENOME --title={SAMPLE} --no-stats >> MapDamage.pdf
 
```


### Options choisies
* -r = on lui précise un génome de référence
* --title = on donne un préfixe qui sera donné aux fichiers crées
* --no-stats= on ne veut récupérer que les grapiques, pas les statitstiques.


### Options choisies

# ETAPE 8 - Génération des séquences consensus 
_Cette étape permet de construire la séquence consensus en fasta à partir des différents reads, htsbox prend à chaque position le résidu le plus commun._

## OUTIL - HTSBOX

Page de documentation de HTSBOX:
<u>https://github.com/lh3/htsbox</u>

### Script
```{bash, echo=T, eval=F}
source /local/env/envconda.sh
    conda activate /groups/Paleogenomics/ENV/htsbox

    htsbox pileup -cCf $GENOME {SAMPLE}_sort_fixmate_MT.sorted.bam | less -S 
    htsbox_env pileup -f $GENOME -q20 -q30 -Fs3 {SAMPLE}_sort_fixmate_MT.sorted.bam > {SAMPLE}_htsbox.fasta

    source /local/env/envpython-3.9.5.sh
    python htsbox_correction.py {SAMPLE}_htsbox.fasta {SAMPLE}_htsbox_corrected.fasta

```


### Options choisies

# ETAPE 9 - Génération des haplogroupes 

_Cette étape se fait en local._
_Mitotoolpy permet d'haplogrouper les échantillons._

## OUTIL - MITOTOOLPY

Page de documentation de MITOTOOLPY:
<u>https://github.com/kizcas/MitoToolPy</u>

### Script
```{bash, echo=T, eval=F}
     source /local/env/envpython-3.9.5.sh
    python $Mitotoolpy -s dog -r whole -i {SAMPLE}_htsbox_corrected.fasta -o {SAMPLE}_MitoToolPy.txt

```

### Options choisies
* -s = pour préciser l'espèce étudiée
* -r = pour prciser la région étudiée, ici on étudie tout le génome mitochondrial


# ETAPE 10 - Multialignement 
_Cet étape est l'alignement de toute les séquences entre elles, la méthode utilisée est G-INS-i qui est propice aux alignements de plus de 200 séquences (ici plus de 400) et de séquences de longueurs similaires (le génome mitochondrial)._


## OUTIL - MAFFT

Page de documentation de MAFFT:
<u>https://mafft.cbrc.jp/alignment/software/manual/manual.html</u>

### Script
```{bash, echo=T, eval=F}
  source /local/env/envmafft-7.475.sh

	mafft --add Data.fasta --reorder Old_alignement.fst > Alignement.fst
	ginsi Alignement.fst > New_alignement.fst

```

### Options choisies

* --add = on ajoute à un alignement déjà fait les nouvelles données
* - ginsi = le typ d'algorithme utilisé

# ETAPE 10bis - Nettoyage de l'alignement
_Cette étape est une étape de curing de l'alignement, elle permet de filtrer les séquences "parasites" qui ne serviront pas à la construction de l'arbre phylogénétique et d'enlever les régions mal alignées ou avec trop de gaps._

## OUTIL - TRIMAL

Page de documentation de TRIMAI:
<u>http://trimal.cgenomics.org/</u>

### Script
```{bash, echo=T, eval=F}
   source /local/env/envconda.sh
    conda activate /groups/Paleogenomics/ENV/trimal 
    trimal -in New_alignement_ginsi.fst -out New_alignement_ginsi_curred_spurious_10%.fst -resoverlap 0.60 -seqoverlap 60 -gt 0.9 # <-- on prend celui là

```

### Options choisies:
* - gt 0.9 = si il y a des gap dans 90% des positions, on supprime la colonne
* -resoverlap 0.60 = trimAI calcul un score à chaque position par rapport à l'élément le plus commun à hauteur de 60%
* -seqoverlap 60 = Si la séquence a 60% de ses positions qui ont un score en dessous du resoverlap, la séquence est supprimée.
--> il faut que 60% de ses positions passent le score pour que la seq soit gardée


# ETAPE 11 - Génération des arbres 

_

## OUTIL - IQTREE

Page de documentation de IQTREE:
<u>http://www.iqtree.org/doc/</u>

### Script
```{bash, echo=T, eval=F}
  source /local/env/envconda.sh
    conda activate /groups/Paleogenomics/ENV/iqtree

     iqtree -s New_alignement_ginsi*.fst -m GTR2+R4+F -b 100 -T 8

```


### Options choisies:
* -s = pour spécifier le nom du fichier d'alignement en input
* -B 1000 = nbr of boostrap replicates for UFboot
* -b 100 = nbr of nonparametric boostrap 
* -m TIM2+I+G = run UFBoot ultrafastbootstrap
* -T 8 specifies the nbr og GPU 


# BIBLIOGRAPHIE

MARTIN, Marcel. Cutadapt removes adapter sequences from high-throughput sequencing reads. EMBnet.journal, [S.l.], v. 17, n. 1, p. pp. 10-12, may 2011. ISSN 2226-6089. Available at: <https://journal.embnet.org/index.php/embnetjournal/article/view/200>. Date accessed: 30 may 2022. doi:https://doi.org/10.14806/ej.17.1.200. 

Shifu Chen, Yanqing Zhou, Yaru Chen, Jia Gu; fastp: an ultra-fast all-in-one FASTQ preprocessor, Bioinformatics, Volume 34, Issue 17, 1 September 2018, Pages i884–i890, https://doi.org/10.1093/bioinformatics/bty560

Di Franco A, Poujol R, Baurain D, Philippe H "Evaluating the usefulness of alignment filtering methods to reduce the impact of errors on evolutionary inferences." BMC Evol Biol. 2019 Jan 11;19(1):21. https://doi.org/10.1186/s12862-019-1350-2

L.-T. Nguyen, H.A. Schmidt, A. von Haeseler, and B.Q. Minh (2015) IQ-TREE: A fast and effective stochastic algorithm for estimating maximum likelihood phylogenies. Mol. Biol. Evol., 32, 268-274. https://doi.org/10.1093/molbev/msu300

PREQUAL: a program for detecting errors in sets of unaligned homologous sequences. Whelan, Irisarri & Burki. In Press. Bioinformatics. https://doi.org/10.1093/bioinformatics/bty448

BBMap – Bushnell B. – sourceforge.net/projects/bbmap/

Li H. and Durbin R. (2010) Fast and accurate long-read alignment with Burrows-Wheeler transform. Bioinformatics, 26, 589-595. [PMID: 20080505]

Heng Li, Bob Handsaker, Alec Wysoker, Tim Fennell, Jue Ruan, Nils Homer, Gabor Marth, Goncalo Abecasis, Richard Durbin, 1000 Genome Project Data Processing Subgroup, The Sequence Alignment/Map format and SAMtools, Bioinformatics, Volume 25, Issue 16, 15 August 2009, Pages 2078–2079, https://doi.org/10.1093/bioinformatics/btp352

Jónsson H, Ginolhac A, Schubert M, Johnson P, Orlando L. mapDamage2.0: fast approximate Bayesian estimates of ancient DNA damage parameters. Bioinformatics 23rd April 2013. doi: 10.1093/bioinformatics/btt193

Peng MS, Fan L, Shi NN, Ning T, Yao YG, Murphy RW, Wang WZ, Zhang YP. DomeTree: a Canonical Toolkit for Mitochondrial DNA Analyses in Domesticated Animals. Molecular Ecology Resources. doi: 10.1111/1755-0998.12386

Kazutaka Katoh, Kazuharu Misawa, Kei‐ichi Kuma, Takashi Miyata, MAFFT: a novel method for rapid multiple sequence alignment based on fast Fourier transform, Nucleic Acids Research, Volume 30, Issue 14, 15 July 2002, Pages 3059–3066, https://doi.org/10.1093/nar/gkf436

Capella-Gutiérrez S, Silla-Martínez JM, Gabaldón T. trimAl: a tool for automated alignment trimming in large-scale phylogenetic analyses. Bioinformatics. 2009;25(15):1972-1973. doi:10.1093/bioinformatics/btp348

